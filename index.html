<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planejador de Férias - Centro de Expertise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .calendar-grid { display: grid; grid-template-columns: 180px repeat(31, minmax(35px, 1fr)); gap: 1px; }
        .day-cell { position: relative; min-height: 30px; }
        .day-cell.overlap::after {
            content: ''; position: absolute; top: 2px; right: 2px; width: 8px; height: 8px;
            background-color: #ef4444; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 1px #ef4444;
        }
        .sticky-col { position: -webkit-sticky; position: sticky; left: 0; z-index: 10; }
        .sticky-header { position: -webkit-sticky; position: sticky; top: 0; z-index: 20; }
        .modal-content { max-height: 80vh; }
        /* Year View Styles */
        .year-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
        .month-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .month-day-cell { width: 100%; padding-bottom: 100%; position: relative; }
        .month-day-cell span { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.75rem; }
        .tooltip { visibility: hidden; opacity: 0; transition: opacity 0.2s; }
        .has-tooltip:hover .tooltip { visibility: visible; opacity: 1; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-6 text-center relative">
            <h1 class="text-3xl font-bold text-gray-900">Planejador de Férias</h1>
            <p class="text-md text-gray-600 mt-1">Centro de Expertise (CE)</p>
            <button id="admin-panel-btn" class="absolute top-0 right-0 px-4 py-2 bg-slate-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-500">
                Admin
            </button>
        </header>

        <!-- Controls Section -->
        <div class="flex flex-col xl:flex-row justify-between items-center mb-4 bg-white p-4 rounded-lg shadow-sm gap-4">
            <div class="flex items-center space-x-2">
                <button id="prev-btn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-md transition-colors">&lt;</button>
                <h2 id="current-display" class="text-xl font-semibold w-48 text-center"></h2>
                <button id="next-btn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-md transition-colors">&gt;</button>
            </div>
             <div class="flex items-center gap-4">
                <div id="team-filter-container">
                    <label for="team-filter" class="sr-only">Filtrar por Equipe</label>
                    <select id="team-filter" class="w-full sm:w-48 p-2 border border-gray-300 rounded-md">
                        <option value="all">Todas as Equipes</option>
                    </select>
                </div>
                <div class="bg-gray-200 p-1 rounded-lg">
                    <button id="month-view-btn" class="px-3 py-1 text-sm font-medium rounded-md bg-white shadow">Mês</button>
                    <button id="year-view-btn" class="px-3 py-1 text-sm font-medium rounded-md text-gray-600">Ano</button>
                </div>
            </div>
            <button id="add-vacation-btn" class="w-full sm:w-auto px-5 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">
                Agendar Ausência
            </button>
        </div>

        <!-- Legend -->
        <div id="legend" class="flex flex-wrap justify-center sm:justify-end items-center gap-x-4 gap-y-2 mb-4 text-sm"></div>

        <!-- Overlap Summary Section -->
        <div id="overlap-summary" class="mb-4"></div>

        <!-- Calendar Section -->
        <div id="month-view-container" class="overflow-x-auto bg-white rounded-lg shadow">
             <div id="calendar-container" class="p-4 min-w-[1400px]"></div>
        </div>
        <div id="year-view-container" class="hidden bg-white rounded-lg shadow p-6"></div>
        <div id="loading-state" class="text-center p-8 text-lg">Carregando dados...</div>
    </div>

    <!-- Modals (Absence and Admin) -->
    <div id="absence-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"><div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md m-4"><h3 class="text-2xl font-bold mb-6">Agendar Ausência</h3><form id="absence-form"><div class="mb-4"><label for="employee-select" class="block text-sm font-medium text-gray-700 mb-1">Colaborador(a)</label><select id="employee-select" class="w-full p-2 border border-gray-300 rounded-md" required></select></div><div class="mb-4"><label for="absence-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Ausência</label><select id="absence-type" class="w-full p-2 border border-gray-300 rounded-md" required><option value="vacation">Férias</option><option value="birthday">Day Off Aniversário</option><option value="short_day">Short Day</option><option value="license">Licença</option></select></div><div class="mb-4"><label for="start-date" class="block text-sm font-medium text-gray-700 mb-1">Data de Início</label><input type="date" id="start-date" class="w-full p-2 border border-gray-300 rounded-md" required></div><div class="mb-4"><label for="end-date" class="block text-sm font-medium text-gray-700 mb-1">Data de Fim</label><input type="date" id="end-date" class="w-full p-2 border border-gray-300 rounded-md" required></div><div class="flex justify-end space-x-4 mt-8"><button type="button" id="cancel-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button><button type="submit" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700">Salvar</button></div></form></div></div>
    <div id="admin-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"><div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-2xl m-4 modal-content overflow-y-auto"><h3 class="text-2xl font-bold mb-6">Painel de Administração</h3><form id="admin-employee-form" class="bg-gray-50 p-4 rounded-lg border mb-6"><h4 class="text-lg font-semibold mb-3" id="admin-form-title">Adicionar Colaborador</h4><input type="hidden" id="admin-employee-id"><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label for="admin-name" class="block text-sm font-medium text-gray-700">Nome</label><input type="text" id="admin-name" class="mt-1 w-full p-2 border border-gray-300 rounded-md" required></div><div><label for="admin-team" class="block text-sm font-medium text-gray-700">Equipe</label><input type="text" id="admin-team" class="mt-1 w-full p-2 border border-gray-300 rounded-md" required></div><div><label for="admin-role" class="block text-sm font-medium text-gray-700">Cargo</label><input type="text" id="admin-role" class="mt-1 w-full p-2 border border-gray-300 rounded-md" required></div></div><div class="flex justify-end space-x-3 mt-4"><button type="button" id="admin-cancel-edit-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 hidden">Cancelar Edição</button><button type="submit" class="px-5 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700">Salvar</button></div></form><h4 class="text-lg font-semibold mb-3">Lista de Colaboradores</h4><div id="admin-employee-list" class="space-y-2"></div><div class="flex justify-end mt-8"><button type="button" id="admin-close-btn" class="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">Fechar Painel</button></div></div></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, setDoc, doc, getDocs, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async function () {
            // --- FIREBASE CONFIG ---
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'vacation-planner-ce';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "your-api-key", authDomain: "your-auth-domain", projectId: "your-project-id" };
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            try {
                if (initialAuthToken) { await signInWithCustomToken(auth, initialAuthToken); } 
                else { await signInAnonymously(auth); }
            } catch (error) { console.error("Authentication failed:", error); document.getElementById('loading-state').textContent = 'Falha na autenticação.'; return; }
            
            // --- COLLECTIONS ---
            const employeesCol = collection(db, `artifacts/${appId}/public/data/employees`);
            const absencesCol = collection(db, `artifacts/${appId}/public/data/absences`);

            // --- LOCAL STATE ---
            let allEmployees = [];
            let allAbsences = [];
            let currentDate = new Date();
            let currentView = 'month'; // 'month' or 'year'

            // --- DOM ELEMENTS ---
            const loadingState = document.getElementById('loading-state');
            const currentDisplay = document.getElementById('current-display');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const monthViewBtn = document.getElementById('month-view-btn');
            const yearViewBtn = document.getElementById('year-view-btn');
            const monthViewContainer = document.getElementById('month-view-container');
            const yearViewContainer = document.getElementById('year-view-container');
            const calendarContainer = document.getElementById('calendar-container');
            const teamFilterContainer = document.getElementById('team-filter-container');
            const legendContainer = document.getElementById('legend');
            const overlapSummaryContainer = document.getElementById('overlap-summary');
            // ... other DOM elements
            const modal = document.getElementById('absence-modal');
            const adminModal = document.getElementById('admin-modal');

            // --- RENDER FUNCTIONS ---
            function render() {
                loadingState.style.display = 'none';
                updateControls();
                renderOverlapSummary();
                if (currentView === 'month') {
                    monthViewContainer.classList.remove('hidden');
                    yearViewContainer.classList.add('hidden');
                    teamFilterContainer.classList.remove('hidden');
                    renderMonthView();
                } else {
                    monthViewContainer.classList.add('hidden');
                    yearViewContainer.classList.remove('hidden');
                    teamFilterContainer.classList.add('hidden');
                    renderYearView();
                }
            }
            
            function updateControls() {
                if (currentView === 'month') {
                    currentDisplay.textContent = `${currentDate.toLocaleString('pt-BR', { month: 'long' })} ${currentDate.getFullYear()}`;
                    monthViewBtn.classList.add('bg-white', 'shadow');
                    monthViewBtn.classList.remove('text-gray-600');
                    yearViewBtn.classList.add('text-gray-600');
                    yearViewBtn.classList.remove('bg-white', 'shadow');
                    renderLegend(false);
                } else {
                    currentDisplay.textContent = currentDate.getFullYear();
                    yearViewBtn.classList.add('bg-white', 'shadow');
                    yearViewBtn.classList.remove('text-gray-600');
                    monthViewBtn.classList.add('text-gray-600');
                    monthViewBtn.classList.remove('bg-white', 'shadow');
                    renderLegend(true);
                }
            }

            function renderLegend(isYearView) {
                legendContainer.innerHTML = '';
                if (isYearView) {
                    const heatmapLegend = [
                        { color: 'bg-yellow-200', label: '1 Ausente' },
                        { color: 'bg-orange-400', label: '2-3 Ausentes' },
                        { color: 'bg-red-500', label: '4+ Ausentes' },
                    ];
                    heatmapLegend.forEach(item => {
                        legendContainer.innerHTML += `<div class="flex items-center"><span class="w-4 h-4 ${item.color} rounded-sm mr-2"></span><span>${item.label}</span></div>`;
                    });
                } else {
                    const monthLegend = [
                        { color: 'bg-amber-400', label: 'Férias' },
                        { color: 'bg-sky-400', label: 'Day Off Aniv.' },
                        { color: 'bg-emerald-400', label: 'Short Day' },
                        { color: 'bg-purple-400', label: 'Licença' },
                    ];
                    monthLegend.forEach(item => {
                        legendContainer.innerHTML += `<div class="flex items-center"><span class="w-4 h-4 ${item.color} rounded-sm mr-2"></span><span>${item.label}</span></div>`;
                    });
                    legendContainer.innerHTML += `<div class="flex items-center"><div class="relative"><span class="w-4 h-4 bg-gray-300 rounded-sm mr-2 block"></span><span class="absolute top-0.5 right-2.5 w-2 h-2 bg-red-500 rounded-full border border-white"></span></div><span>Sobreposição</span></div>`;
                }
            }

            function renderMonthView() {
                // This is the refactored renderCalendar function
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const selectedTeam = document.getElementById('team-filter').value;
                calendarContainer.innerHTML = '';
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                const headerRow = document.createElement('div');
                headerRow.className = 'calendar-grid';
                let headerHTML = '<div class="font-semibold bg-gray-200 p-2 sticky-header sticky-col">Colaborador</div>';
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dayOfWeek = date.toLocaleString('pt-BR', { weekday: 'short' }).slice(0, 1).toUpperCase();
                    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                    headerHTML += `<div class="font-semibold text-center p-1 text-sm sticky-header ${isWeekend ? 'bg-gray-300' : 'bg-gray-200'}"><div>${dayOfWeek}</div><div>${day}</div></div>`;
                }
                headerRow.innerHTML = headerHTML;
                calendarContainer.appendChild(headerRow);

                const dailyOverlapCount = getDailyOverlapCountForMonth(year, month);
                const filteredEmployees = allEmployees
                    .filter(emp => selectedTeam === 'all' || emp.team === selectedTeam)
                    .sort((a, b) => a.name.localeCompare(b.name));

                if (filteredEmployees.length === 0 && allEmployees.length > 0) {
                     calendarContainer.innerHTML += `<div class="text-center p-4 col-span-32">Nenhum colaborador encontrado.</div>`;
                     return;
                }

                filteredEmployees.forEach(employee => {
                    const employeeRow = document.createElement('div');
                    employeeRow.className = 'calendar-grid';
                    let rowHTML = `<div class="font-medium bg-gray-50 p-2 text-sm truncate sticky-col">${employee.name}</div>`;
                    for (let day = 1; day <= daysInMonth; day++) {
                        const cellDate = new Date(Date.UTC(year, month, day));
                        const isWeekend = cellDate.getUTCDay() === 0 || cellDate.getUTCDay() === 6;
                        let cellClass = isWeekend ? 'bg-gray-200' : 'bg-white';
                        let onAbsence = false;
                        let absenceType = '';
                        allAbsences.filter(a => a.employeeId === employee.id).forEach(absence => {
                            const start = new Date(absence.start + 'T00:00:00Z');
                            const end = new Date(absence.end + 'T00:00:00Z');
                            if (cellDate >= start && cellDate <= end) {
                                onAbsence = true;
                                absenceType = absence.type;
                            }
                        });
                        if (onAbsence) {
                            const colorMap = { vacation: 'bg-amber-400', birthday: 'bg-sky-400', short_day: 'bg-emerald-400', license: 'bg-purple-400' };
                            cellClass = colorMap[absenceType] || 'bg-gray-400';
                        }
                        const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const hasOverlap = dailyOverlapCount[dateString] > 1 && onAbsence;
                        rowHTML += `<div class="day-cell border-t border-gray-200 ${cellClass} ${hasOverlap ? 'overlap' : ''}"></div>`;
                    }
                    employeeRow.innerHTML = rowHTML;
                    calendarContainer.appendChild(employeeRow);
                });
            }

            function renderYearView() {
                const year = currentDate.getFullYear();
                yearViewContainer.innerHTML = '';
                
                const yearGrid = document.createElement('div');
                yearGrid.className = 'year-grid';
                
                const dailyAbsenceMap = getDailyAbsenceMapForYear(year);

                for (let month = 0; month < 12; month++) {
                    const monthContainer = document.createElement('div');
                    const monthName = new Date(year, month).toLocaleString('pt-BR', { month: 'long' });
                    let monthHTML = `<h3 class="text-lg font-semibold mb-2 text-center">${monthName.charAt(0).toUpperCase() + monthName.slice(1)}</h3>`;
                    
                    monthHTML += '<div class="month-grid text-xs font-semibold text-gray-500 mb-1">';
                    ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'].forEach(day => monthHTML += `<div>${day}</div>`);
                    monthHTML += '</div>';

                    monthHTML += '<div class="month-grid">';
                    const firstDay = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();

                    for (let i = 0; i < firstDay; i++) { monthHTML += '<div></div>'; }

                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const absentEmployees = dailyAbsenceMap.get(dateString) || [];
                        const count = absentEmployees.length;
                        let colorClass = 'bg-gray-100';
                        if (count > 0) {
                            if (count >= 4) colorClass = 'bg-red-500 text-white';
                            else if (count >= 2) colorClass = 'bg-orange-400 text-white';
                            else colorClass = 'bg-yellow-200';
                        }
                        
                        let tooltipHTML = '';
                        if (count > 0) {
                            tooltipHTML = `<div class="tooltip absolute bottom-full mb-2 w-48 bg-gray-800 text-white text-xs rounded py-1 px-2 z-10 pointer-events-none">
                                            <p class="font-bold mb-1">${day}/${month+1}/${year}</p>
                                            ${absentEmployees.map(e => `<p>${e.name}</p>`).join('')}
                                         </div>`;
                        }

                        monthHTML += `<div class="month-day-cell rounded-sm ${colorClass} ${count > 0 ? 'has-tooltip' : ''}">
                                        <span>${day}</span>
                                        ${tooltipHTML}
                                      </div>`;
                    }
                    monthHTML += '</div>';
                    monthContainer.innerHTML = monthHTML;
                    yearGrid.appendChild(monthContainer);
                }
                yearViewContainer.appendChild(yearGrid);
            }

            // --- DATA & HELPER FUNCTIONS ---
            function getDailyAbsenceMapForYear(year) {
                const dailyMap = new Map();
                allAbsences.forEach(abs => {
                    const start = new Date(abs.start + 'T00:00:00Z');
                    const end = new Date(abs.end + 'T00:00:00Z');
                    if (start.getUTCFullYear() > year && end.getUTCFullYear() < year) return;

                    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                        if (d.getUTCFullYear() !== year) continue;
                        const dateString = d.toISOString().split('T')[0];
                        if (!dailyMap.has(dateString)) dailyMap.set(dateString, []);
                        const employee = allEmployees.find(e => e.id === abs.employeeId);
                        if (employee) dailyMap.get(dateString).push(employee);
                    }
                });
                return dailyMap;
            }
            
            // ... Other helper functions like renderOverlapSummary, getDailyOverlapCountForMonth, populateSelects, etc.
            // These functions are mostly unchanged and are omitted here for brevity, but they are in the full code.
            function renderOverlapSummary() {
                const today = new Date(); today.setHours(0, 0, 0, 0);
                const futureAbsences = allAbsences.filter(abs => new Date(abs.end + 'T00:00:00Z') >= today);
                if (futureAbsences.length < 2) { overlapSummaryContainer.innerHTML = ''; return; }
                const dailyAbsences = new Map();
                futureAbsences.forEach(abs => {
                    const start = new Date(abs.start + 'T00:00:00Z'); const end = new Date(abs.end + 'T00:00:00Z');
                    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                        if (d < today) continue;
                        const dateString = d.toISOString().split('T')[0];
                        if (!dailyAbsences.has(dateString)) dailyAbsences.set(dateString, []);
                        const employee = allEmployees.find(e => e.id === abs.employeeId);
                        if (employee) dailyAbsences.get(dateString).push(employee);
                    }
                });
                const overlapDays = Array.from(dailyAbsences.entries()).filter(([date, employees]) => employees.length > 1).sort((a, b) => a[0].localeCompare(b[0]));
                if (overlapDays.length === 0) { overlapSummaryContainer.innerHTML = ''; return; }
                const overlapIntervals = []; let currentInterval = null;
                for (const [dateString, employees] of overlapDays) {
                    const employeeIds = employees.map(e => e.id).sort().join(','); const currentDate = new Date(dateString + 'T00:00:00Z');
                    if (!currentInterval) { currentInterval = { start: currentDate, employees: employees, employeeIds: employeeIds };
                    } else {
                        const prevDate = new Date(currentInterval.end || currentInterval.start); prevDate.setDate(prevDate.getDate() + 1);
                        if (currentDate.getTime() === prevDate.getTime() && employeeIds === currentInterval.employeeIds) { currentInterval.end = currentDate; } 
                        else { overlapIntervals.push(currentInterval); currentInterval = { start: currentDate, employees: employees, employeeIds: employeeIds }; }
                    }
                }
                if (currentInterval) overlapIntervals.push(currentInterval);
                let summaryHTML = `<div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200"><h3 class="text-lg font-semibold mb-3 text-gray-800">Resumo de Sobreposições Futuras</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`;
                overlapIntervals.forEach(interval => {
                    const teams = interval.employees.map(e => e.team); const hasSameTeamOverlap = new Set(teams).size < teams.length;
                    const formatDate = (date) => date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                    let dateRange = formatDate(interval.start); if (interval.end) dateRange += ` a ${formatDate(interval.end)}`;
                    summaryHTML += `<div class="p-3 rounded-md ${hasSameTeamOverlap ? 'bg-red-50 border border-red-200' : 'bg-gray-50 border border-gray-200'}"><div class="font-bold text-md flex items-center ${hasSameTeamOverlap ? 'text-red-700' : 'text-gray-700'}">${hasSameTeamOverlap ? `<svg class="w-5 h-5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>` : ''}${dateRange}</div><ul class="mt-2 text-sm space-y-1">${interval.employees.map(emp => `<li class="text-gray-600"><span class="font-medium">${emp.name}</span> (${emp.team})</li>`).join('')}</ul></div>`;
                });
                summaryHTML += `</div></div>`; overlapSummaryContainer.innerHTML = summaryHTML;
            }
            function getDailyOverlapCountForMonth(year, month) {
                const counts = {}; const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; counts[dateString] = 0;
                    const cellDate = new Date(Date.UTC(year, month, day));
                    allAbsences.forEach(abs => {
                        const start = new Date(abs.start + 'T00:00:00Z'); const end = new Date(abs.end + 'T00:00:00Z');
                        if (cellDate >= start && cellDate <= end) counts[dateString]++;
                    });
                } return counts;
            }
            function populateSelects() {
                const employeeSelect = document.getElementById('employee-select'); employeeSelect.innerHTML = '';
                allEmployees.sort((a,b) => a.name.localeCompare(b.name)).forEach(emp => {
                    const option = document.createElement('option'); option.value = emp.id; option.textContent = emp.name; employeeSelect.appendChild(option);
                });
                const teamFilter = document.getElementById('team-filter'); const teams = [...new Set(allEmployees.map(emp => emp.team))].sort();
                const currentFilterValue = teamFilter.value; teamFilter.innerHTML = '<option value="all">Todas as Equipes</option>';
                teams.forEach(team => {
                    const option = document.createElement('option'); option.value = team; option.textContent = team; teamFilter.appendChild(option);
                });
                teamFilter.value = currentFilterValue;
            }
            function toggleModal(modalElement, show) { modalElement.classList.toggle('hidden', !show); modalElement.classList.toggle('flex', show); }
            function renderAdminList() {
                const adminEmployeeList = document.getElementById('admin-employee-list'); adminEmployeeList.innerHTML = '';
                allEmployees.sort((a,b) => a.name.localeCompare(b.name)).forEach(emp => {
                    const div = document.createElement('div'); div.className = 'flex justify-between items-center bg-gray-100 p-2 rounded';
                    div.innerHTML = `<div><p class="font-semibold">${emp.name}</p><p class="text-sm text-gray-600">${emp.role} - ${emp.team}</p></div><div class="space-x-2"><button data-id="${emp.id}" class="edit-employee-btn px-3 py-1 bg-yellow-500 text-white text-sm rounded hover:bg-yellow-600">Editar</button><button data-id="${emp.id}" class="delete-employee-btn px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">Excluir</button></div>`;
                    adminEmployeeList.appendChild(div);
                });
            }
            function resetAdminForm() {
                const adminEmployeeForm = document.getElementById('admin-employee-form'); adminEmployeeForm.reset();
                document.getElementById('admin-employee-id').value = ''; document.getElementById('admin-form-title').textContent = 'Adicionar Colaborador';
                document.getElementById('admin-cancel-edit-btn').classList.add('hidden');
            }


            // --- EVENT LISTENERS ---
            prevBtn.addEventListener('click', () => {
                if (currentView === 'month') currentDate.setMonth(currentDate.getMonth() - 1);
                else currentDate.setFullYear(currentDate.getFullYear() - 1);
                render();
            });
            nextBtn.addEventListener('click', () => {
                if (currentView === 'month') currentDate.setMonth(currentDate.getMonth() + 1);
                else currentDate.setFullYear(currentDate.getFullYear() + 1);
                render();
            });
            monthViewBtn.addEventListener('click', () => { if (currentView !== 'month') { currentView = 'month'; render(); } });
            yearViewBtn.addEventListener('click', () => { if (currentView !== 'year') { currentView = 'year'; render(); } });
            document.getElementById('team-filter').addEventListener('change', renderMonthView);
            // ... other listeners for modals and forms are unchanged and omitted for brevity
            document.getElementById('add-vacation-btn').addEventListener('click', () => { document.getElementById('absence-form').reset(); document.getElementById('end-date').disabled = false; toggleModal(modal, true); });
            document.getElementById('cancel-btn').addEventListener('click', () => toggleModal(modal, false));
            modal.addEventListener('click', (e) => { if (e.target === modal) toggleModal(modal, false); });
            document.getElementById('absence-type').addEventListener('change', (e) => { const isSingleDay = e.target.value === 'birthday' || e.target.value === 'short_day'; const endDateInput = document.getElementById('end-date'); const startDateInput = document.getElementById('start-date'); endDateInput.disabled = isSingleDay; if (isSingleDay && startDateInput.value) endDateInput.value = startDateInput.value; });
            document.getElementById('start-date').addEventListener('change', (e) => { const isSingleDay = document.getElementById('absence-type').value === 'birthday' || document.getElementById('absence-type').value === 'short_day'; if (isSingleDay) document.getElementById('end-date').value = e.target.value; });
            document.getElementById('absence-form').addEventListener('submit', async (e) => { e.preventDefault(); const newAbsence = { employeeId: document.getElementById('employee-select').value, type: document.getElementById('absence-type').value, start: document.getElementById('start-date').value, end: document.getElementById('end-date').value, addedBy: auth.currentUser?.uid || 'anonymous', createdAt: new Date() }; if (new Date(newAbsence.end) < new Date(newAbsence.start)) return; try { await addDoc(absencesCol, newAbsence); toggleModal(modal, false); } catch (error) { console.error("Error adding absence: ", error); } });
            document.getElementById('admin-panel-btn').addEventListener('click', () => toggleModal(adminModal, true));
            document.getElementById('admin-close-btn').addEventListener('click', () => toggleModal(adminModal, false));
            document.getElementById('admin-cancel-edit-btn').addEventListener('click', resetAdminForm);
            document.getElementById('admin-employee-form').addEventListener('submit', async (e) => { e.preventDefault(); const employeeData = { name: document.getElementById('admin-name').value, team: document.getElementById('admin-team').value, role: document.getElementById('admin-role').value, }; try { const employeeId = document.getElementById('admin-employee-id').value; if (employeeId) { await setDoc(doc(db, `artifacts/${appId}/public/data/employees`, employeeId), employeeData); } else { await addDoc(employeesCol, employeeData); } resetAdminForm(); } catch (error) { console.error("Error saving employee: ", error); } });
            document.getElementById('admin-employee-list').addEventListener('click', async (e) => { const target = e.target; const employeeId = target.dataset.id; if (!employeeId) return; if (target.classList.contains('edit-employee-btn')) { const employee = allEmployees.find(emp => emp.id === employeeId); if (employee) { document.getElementById('admin-form-title').textContent = 'Editar Colaborador'; document.getElementById('admin-employee-id').value = employee.id; document.getElementById('admin-name').value = employee.name; document.getElementById('admin-team').value = employee.team; document.getElementById('admin-role').value = employee.role; document.getElementById('admin-cancel-edit-btn').classList.remove('hidden'); document.getElementById('admin-name').focus(); } } if (target.classList.contains('delete-employee-btn')) { try { await deleteDoc(doc(db, `artifacts/${appId}/public/data/employees`, employeeId)); } catch (error) { console.error("Error deleting employee: ", error); } } });


            // --- INITIALIZATION & REAL-TIME LISTENERS ---
            await seedInitialData();
            onSnapshot(employeesCol, (snapshot) => {
                allEmployees = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateSelects();
                render();
                renderAdminList();
            });
            onSnapshot(absencesCol, (snapshot) => {
                allAbsences = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
            
            function seedInitialData() { /* Omitted for brevity */ }
        });
    </script>
</body>
</html>
